{% extends "base/base.html" %}
{% load static %}
{% block title %}نظرات شما{% endblock %}
{% block start %}

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Vazirmatn', sans-serif;
    direction: rtl;
    color: #212529 !important;
    background-color: #f8f9fa;
  }
  .section-content {
    padding: 5rem 0;
  }
  .container-xl {
    background-color: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 0.15rem 1.75rem 0 rgb(33 40 50 / 15%);
  }
  .card {
    border-radius: 8px;
    box-shadow: 0 0.15rem 1.75rem 0 rgb(33 40 50 / 15%);
    border: none;
  }
  .card-body {
    color: #212529 !important;
  }
  .card-title a {
    color: #212529 !important;
    text-decoration: none;
  }
  .card-title a:hover {
    color: #0066cc !important;
  }
  .btn-outline-primary, .btn-outline-danger {
    border-radius: 30px;
    font-weight: 500;
  }
  .btn-outline-primary {
    border-color: #0066cc;
    color: #0066cc !important;
  }
  .btn-outline-primary:hover {
    background-color: #0066cc;
    color: #fff !important;
  }
  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545 !important;
  }
  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff !important;
  }
  h2 {
    color: #0066cc !important;
    font-weight: 700;
  }
  .text-muted {
    color: #6c757d !important;
  }
  .modal-content {
    color: #212529 !important;
  }
  .img-fluid {
    max-width: 100%;
    height: auto;
    object-fit: cover;
  }
</style>

<section class="section-content padding-y">
  <div class="container-xl d-flex justify-content-center align-items-center">
    <div class="row justify-content-center w-100">
      <div class="container">
        {% include 'base/alert.html' %}
        <h2 class="mb-4 text-center">نظرات محصولات</h2>
        {% if reviews %}
        <div class="row">
          {% for review in reviews %}
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm rounded">
              <div class="row g-0 align-items-center">
                <div class="col-4">
                  <img
                    src="/media/{{ review.product.product_images.first.image }}"
                    class="img-fluid rounded-start"
                    alt="{{ review.product.product_name }}"
                    style="width: 100%; height: auto; object-fit: cover"
                  />
                </div>
                <div class="col-8">
                  <div class="card-body">
                    <h5 class="card-title">
                      <a href="{% url 'get_product' review.product.slug %}" class="text-decoration-none">
                        {{ review.product.product_name }}
                      </a>
                    </h5>
                    <small class="text-muted">ارسال شده در {{ review.date_added|date:"d F Y" }}</small>
                    <p class="mt-2"><strong>امتیاز:</strong>
                      {% for i in "12345" %}
                        {% if forloop.counter <= review.stars %}
                          <i class="fas fa-star" style="color: #f1c40f;"></i>
                        {% else %}
                          <i class="far fa-star" style="color: #f1c40f;"></i>
                        {% endif %}
                      {% endfor %}
                    </p>
                    <p class="card-text" title="{{ review.content }}">
                      <strong>نظر:</strong> {{ review.content|truncatechars:50 }}
                    </p>
                  </div>
                </div>
              </div>
              <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                <button
                  class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center"
                  style="width: 45%;"
                  data-bs-toggle="modal"
                  data-bs-target="#editReviewModal"
                  data-review-id="{{ review.uid }}"
                  data-review-stars="{{ review.stars }}"
                  data-review-content="{{ review.content }}"
                >
                  <i class="bi bi-pencil-square me-1"></i> ویرایش
                </button>
                <form
                  method="POST"
                  action="{% url 'delete_review' review.product.slug review.uid %}"
                  style="display: inline; width: 45%"
                >
                  {% csrf_token %}
                  <button
                    class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center"
                    style="width: 100%;"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteReviewModal"
                    onclick="setDeleteAction('{% url 'delete_review' review.product.slug review.uid %}')"
                    type="button"
                  >
                    <i class="bi bi-trash-fill me-1"></i> حذف
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-muted">شما هنوز نظری ننوشته‌اید.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div
    class="modal fade"
    id="deleteReviewModal"
    tabindex="-1"
    aria-labelledby="deleteReviewModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteReviewModalLabel">تأیید حذف</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          آیا مطمئن هستید که می‌خواهید این نظر را حذف کنید؟
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            لغو
          </button>
          <form id="deleteReviewForm" method="POST" style="display: inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">حذف</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div
    class="modal fade"
    id="editReviewModal"
    tabindex="-1"
    aria-labelledby="editReviewModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editReviewModalLabel">ویرایش نظر</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form id="editReviewForm" method="POST">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label for="editStars" class="form-label">امتیاز</label>
              <input
                type="number"
                class="form-control"
                id="editStars"
                name="stars"
                min="1"
                max="5"
                required
              />
            </div>
            <div class="mb-3">
              <label for="editContent" class="form-label">متن نظر</label>
              <textarea
                class="form-control"
                id="editContent"
                name="content"
                rows="4"
                required
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              لغو
            </button>
            <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const editReviewModal = document.getElementById("editReviewModal");
    editReviewModal.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      const reviewId = button.getAttribute("data-review-id");
      const reviewStars = button.getAttribute("data-review-stars");
      const reviewContent = button.getAttribute("data-review-content");

      const starsInput = editReviewModal.querySelector("#editStars");
      const contentTextarea = editReviewModal.querySelector("#editContent");
      const form = editReviewModal.querySelector("#editReviewForm");

      starsInput.value = reviewStars;
      contentTextarea.value = reviewContent;
      form.action = "/product/product-reviews/edit/" + reviewId + "/";
    });
  });

  function setDeleteAction(actionUrl) {
    const deleteForm = document.getElementById("deleteReviewForm");
    deleteForm.action = actionUrl;
  }
</script>

{% endblock %}